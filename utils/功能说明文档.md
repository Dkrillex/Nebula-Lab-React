# Utils 工具函数文档

本目录包含项目中使用的各种工具函数，提供通用的功能封装，便于在项目中复用。

## 工具函数列表

### 1. **crypto.ts** - 加密工具函数
- **功能**: 提供 AES 加密/解密和 Base64 编码功能，用于数据加密传输
- **函数**:
  - `generateAesKey()`: 随机生成 AES 密钥
  - `encryptBase64(str)`: Base64 编码
  - `encryptWithAes(message, aesKey)`: 使用 AES 加密数据（ECB/Pkcs7 模式）
  - `decryptBase64(str)`: Base64 解码
  - `decryptWithAes(encrypted, aesKey)`: 使用 AES 解密数据
- **使用场景**: 请求数据加密、敏感信息加密传输
- **依赖**: `crypto-js` 库

### 2. **jsencrypt.ts** - RSA 加密工具
- **功能**: 提供 RSA 公钥加密和私钥解密功能
- **函数**:
  - `encrypt(txt)`: 使用 RSA 公钥加密（用于请求加密）
  - `decrypt(txt)`: 使用 RSA 私钥解密（用于响应解密）
- **配置**: 从 `constants.ts` 中读取 `RSA_PUBLIC_KEY` 和 `RSA_PRIVATE_KEY`
- **使用场景**: 与后端进行加密通信，保护敏感数据传输
- **依赖**: `jsencrypt` 库
- **注意**: 密钥对可通过 http://web.chacuo.net/netrsakeypair 生成

### 3. **dateUtils.ts** - 日期格式化工具
- **功能**: 提供日期格式化和解析功能
- **函数**:
  - `formatDateTime(date)`: 格式化日期为 `yyyy-MM-dd HH:mm:ss` 格式
    - 支持 Date 对象、时间戳、日期字符串
    - 无效日期返回空字符串
  - `parseDateTime(dateString)`: 解析日期字符串为 Date 对象
    - 支持标准格式 `yyyy-MM-dd HH:mm:ss`
    - 解析失败返回 null
  - `formatDateForBackend(date)`: 格式化日期为后端可接受的格式
    - 用于提交数据时格式化日期字段
    - 无效日期返回 undefined
- **使用场景**: 日期显示、表单日期字段格式化、API 请求日期参数格式化

### 4. **ruoyi.ts** - Ruoyi 框架工具函数
- **功能**: 提供与 Ruoyi 后端框架兼容的参数序列化和错误码映射
- **函数**:
  - `tansParams(params)`: 参数序列化（兼容 Ruoyi 格式）
    - 用于 GET 请求的查询参数序列化
    - 支持嵌套对象参数
  - `stringifyParams(params, options)`: 参数序列化（支持数组格式）
    - 支持三种数组格式：`repeat`（默认）、`brackets`、`indices`
    - 支持嵌套对象参数
  - `errorCode`: 错误码映射对象
    - `'401'`: '认证失败，无法访问系统资源'
    - `'403'`: '当前操作没有权限'
    - `'404'`: '访问资源不存在'
    - `'default'`: '系统未知错误，请反馈给管理员'
- **使用场景**: 
  - API 请求参数序列化
  - 错误信息显示
  - 与 Ruoyi 后端框架的数据格式兼容

### 5. **upload.ts** - 文件上传工具
- **功能**: 提供文件上传到 TV OSS 的功能
- **函数**:
  - `uploadTVFile(file)`: 上传文件到 TV OSS
    - 自动获取上传凭证
    - 处理文件类型转换（mpeg -> mp3, quicktime -> mp4）
    - 返回上传后的文件信息（fileId, fileName, format, fileUrl）
- **使用场景**: 数字人视频、音频等文件上传到 TV OSS
- **依赖**: `avatarService` 获取上传凭证
- **注意**: 使用 PUT 方法直接上传到 OSS，支持大文件上传

### 6. **videoUtils.ts** - 视频处理工具
- **功能**: 提供视频处理相关的工具函数
- **函数**:
  - `mergeVideos(videoUrls)`: 合并多个视频片段
    - 支持多个视频 URL 合并为一个视频
    - 使用 Canvas 和 MediaRecorder 实现
    - 返回合并后的视频 Blob URL
    - 支持超时保护（最多 10 分钟）
  - `downloadVideo(videoUrl, filename)`: 下载视频文件
    - 从 URL 下载视频并保存到本地
    - 支持自定义文件名
  - `formatDuration(seconds)`: 格式化视频时长
    - 将秒数转换为 `HH:mm:ss` 或 `mm:ss` 格式
  - `getVideoDuration(videoUrl)`: 获取视频时长
    - 异步获取视频的时长（秒）
    - 返回 Promise<number>
- **使用场景**: 
  - 视频片段合并
  - 视频下载
  - 视频时长显示
  - 视频处理相关功能

## 使用示例

### 日期格式化
```typescript
import { formatDateTime, parseDateTime } from '@/utils/dateUtils';

// 格式化日期
const formatted = formatDateTime(new Date()); // "2025-01-15 10:30:00"

// 解析日期字符串
const date = parseDateTime('2025-01-15 10:30:00'); // Date 对象
```

### 参数序列化
```typescript
import { stringifyParams } from '@/utils/ruoyi';

const params = {
  name: 'test',
  tags: ['tag1', 'tag2'],
  filters: { status: 'active' }
};

const queryString = stringifyParams(params);
// "name=test&tags=tag1&tags=tag2&filters[status]=active"
```

### 文件上传
```typescript
import { uploadTVFile } from '@/utils/upload';

const file = new File(['content'], 'video.mp4', { type: 'video/mp4' });
const result = await uploadTVFile(file);
console.log(result.fileId, result.fileUrl);
```

### 视频合并
```typescript
import { mergeVideos } from '@/utils/videoUtils';

const videoUrls = ['url1.mp4', 'url2.mp4', 'url3.mp4'];
const mergedUrl = await mergeVideos(videoUrls);
// 返回合并后的视频 Blob URL
```

### 加密
```typescript
import { encrypt, decrypt } from '@/utils/jsencrypt';
import { generateAesKey, encryptWithAes, decryptWithAes } from '@/utils/crypto';

// RSA 加密
const encrypted = encrypt('sensitive data');

// AES 加密
const aesKey = generateAesKey();
const encryptedData = encryptWithAes('data', aesKey);
```

## 注意事项

1. **日期处理**: `dateUtils` 中的函数会处理各种边界情况，无效日期会返回空字符串或 null
2. **加密安全**: RSA 和 AES 密钥应妥善保管，不要暴露在前端代码中
3. **视频处理**: `mergeVideos` 功能依赖浏览器 MediaRecorder API，部分浏览器可能不支持
4. **文件上传**: `uploadTVFile` 需要先获取上传凭证，确保网络连接正常
5. **参数序列化**: `stringifyParams` 会自动过滤 null、undefined 和空字符串
6. **错误处理**: 所有工具函数都应进行适当的错误处理，避免程序崩溃

## 添加新工具函数

1. 在 `utils/` 目录下创建新的工具文件或添加到现有文件
2. 使用 TypeScript 编写，提供完整的类型定义
3. 添加 JSDoc 注释说明函数用途和参数
4. 处理边界情况和错误情况
5. 在文档中更新函数列表和使用示例

## 更新日期

最后更新：2025-01-XX

