# Request 请求库文档

## 概述

`request.ts` 是一个基于原生 `fetch` API 封装的 HTTP 请求库，提供了类似 Axios 的功能，包括请求/响应拦截、加密、错误处理等。

## 核心功能

### 1. **请求客户端创建**
- `createRequestClient()`: 创建自定义配置的请求客户端
- 支持自定义 baseURL、响应转换、超时时间

### 2. **导出的客户端实例**
- `requestClient`: 默认请求客户端（带响应转换）
- `ygRequestClient`: 无响应转换的客户端
- `DownloadRequestClient`: 长超时客户端（120秒，用于下载）
- `baseRequestClient`: 基础客户端（无响应转换）

### 3. **请求方法**
- `get<T>(url, options)`: GET 请求
- `post<T>(url, body, options)`: POST 请求
- `put<T>(url, body, options)`: PUT 请求
- `delete<T>(url, options)`: DELETE 请求
- `upload<T>(url, file, options)`: 文件上传
- `request<T>(url, options)`: 通用请求方法

## 主要特性

### 1. **加密支持**
- 支持请求体加密（RSA + AES 混合加密）
- 支持响应解密
- 可通过 `encrypt` 选项启用
- 使用环境变量 `VITE_ENABLE_ENCRYPT` 控制全局加密开关

### 2. **认证处理**
- 自动注入 Authorization Bearer Token
- 支持跳过认证的 API 列表（`SKIP_AUTH_APIS`）
- Token 过期自动登出处理

### 3. **请求配置选项 (RequestOptions)**
```typescript
interface RequestOptions {
  params?: Record<string, any>;        // URL 参数
  timeout?: number;                    // 超时时间
  isToken?: boolean;                   // 是否携带 Token（默认 true）
  encrypt?: boolean;                   // 是否加密（默认 false）
  repeatSubmit?: boolean;              // 防重复提交（默认 true，模拟）
  _skipAuth?: boolean;                 // 跳过认证检查
  _skipErrorDisplay?: boolean;         // 跳过错误显示
  errorMessageMode?: 'modal' | 'message' | 'none';  // 错误显示模式
  successMessageMode?: 'modal' | 'message' | 'none'; // 成功消息模式
  isTransformResponse?: boolean;       // 是否转换响应
  isReturnNativeResponse?: boolean;    // 是否返回原生响应
  responseType?: 'json' | 'blob' | 'arraybuffer' | 'text'; // 响应类型
}
```

### 4. **响应处理**
- 自动解析 JSON 响应
- 支持 Ruoyi 标准响应格式：`{ code, msg, data }`
- 自动处理分页格式：`{ rows, total }`
- 支持二进制数据（Blob/ArrayBuffer）
- 自动错误码映射

### 5. **错误处理**
- 自定义 `ApiError` 类
- HTTP 状态码错误处理
- 业务错误码处理（code !== 200）
- 401 自动登出
- 网络错误、超时错误处理
- 可配置的错误显示模式

### 6. **国际化支持**
- 自动添加 `Accept-Language` 和 `Content-Language` 头
- 从 localStorage 读取语言设置
- 语言格式转换（zh -> zh_CN, en -> en_US）

### 7. **请求头管理**
- 自动添加 `Clientid` 头
- 自动设置 `Content-Type`（JSON 或 FormData）
- 加密时添加 `encrypt-key` 头
- 支持自定义请求头

### 8. **URL 参数处理**
- GET/DELETE 请求自动拼接查询参数
- 使用 `stringifyParams` 和 `tansParams` 工具函数
- 支持数组格式参数

## 使用示例

### 基本 GET 请求
```typescript
import { request } from '@/lib/request';

const data = await request.get('/api/users');
```

### POST 请求（带加密）
```typescript
const result = await request.post('/api/users', {
  name: 'John',
  email: 'john@example.com'
}, {
  encrypt: true
});
```

### 文件上传
```typescript
const file = new File(['content'], 'test.txt');
const result = await request.upload('/api/upload', file);
```

### 跳过认证
```typescript
const data = await request.get('/api/public/data', {
  _skipAuth: true
});
```

### 下载文件
```typescript
import { DownloadRequestClient } from '@/lib/request';

const blob = await DownloadRequestClient.get('/api/download/file', {
  responseType: 'blob'
});
```

## 错误处理

### 捕获错误
```typescript
try {
  const data = await request.get('/api/data');
} catch (error) {
  if (error instanceof ApiError) {
    console.error('错误码:', error.code);
    console.error('错误信息:', error.message);
    console.error('错误数据:', error.data);
  }
}
```

### 跳过错误提示
```typescript
try {
  const data = await request.get('/api/data', {
    _skipErrorDisplay: true
  });
} catch (error) {
  // 自行处理错误，不会显示全局错误提示
}
```

## 跳过认证的 API 列表

以下 API 路径会自动跳过认证检查：
- `/resource/sse/close`
- `/resource/sms`
- `/resource/email`
- `/auth`
- `/api/models/list`
- `/api/pricing/list`
- `/ads/labTemplate/list`
- `/tp/v1/ProductAvatarQuery`

## 注意事项

1. **加密功能**: 仅在 `encrypt: true` 时启用，且仅对 POST/PUT 请求的 JSON 体加密
2. **FormData**: 上传文件时使用 FormData，不会进行加密
3. **超时处理**: 默认超时时间由 `API_TIMEOUT` 常量定义
4. **Token 管理**: Token 从 `useAuthStore` 或 localStorage 获取
5. **响应转换**: 默认会自动提取 `data` 字段，如需完整响应可设置 `isReturnNativeResponse: true`

