# Stores 状态管理文档

本目录包含项目中使用的所有 Zustand 状态管理 Store。所有 Store 都使用 Zustand 库进行状态管理，部分 Store 使用持久化中间件将数据保存到 localStorage。

## Store 列表

### 1. **authStore.tsx** - 认证状态管理
- **功能**: 管理用户认证状态、用户信息和登录/登出操作
- **状态**:
  - `user`: 当前用户信息（UserInfo | null）
  - `token`: 认证令牌（string | null）
  - `loading`: 加载状态（boolean）
  - `isAuthenticated`: 是否已认证（boolean）
- **方法**:
  - `login(params)`: 账号密码登录
  - `phoneLogin(params)`: 手机号验证码登录
  - `logout()`: 登出
  - `fetchUserInfo()`: 获取用户信息
  - `setUserInfo(userInfo)`: 设置用户信息
- **持久化**: 使用 `persist` 中间件，将 token 和 userInfo 保存到 localStorage
- **使用场景**: 全局用户认证状态管理，在需要认证的页面和组件中使用

### 2. **cacheStore.ts** - 组件缓存管理
- **功能**: 管理需要缓存的组件列表，用于 KeepAlive 功能
- **状态**:
  - `cachedComponents`: 需要缓存的组件名称集合（Set<string>）
  - `excludeCachedComponents`: 需要排除缓存的组件名称集合（Set<string>）
- **方法**:
  - `updateCachedComponents(components)`: 批量更新缓存组件列表
  - `addCachedComponent(componentName)`: 添加需要缓存的组件
  - `removeCachedComponent(componentName)`: 移除缓存的组件
  - `addExcludeCachedComponent(componentName)`: 添加需要排除缓存的组件
  - `removeExcludeCachedComponent(componentName)`: 移除排除缓存的组件
  - `clearCache()`: 清空所有缓存
- **持久化**: 不使用持久化，仅内存存储
- **使用场景**: 配合 KeepAlive 组件使用，控制哪些组件需要保持状态

### 3. **dictStore.ts** - 字典数据缓存
- **功能**: 缓存系统字典数据，避免重复请求
- **状态**:
  - `dictCache`: 字典数据缓存（Record<string, DictData[]>）
    - key: 字典类型（如 'sys_user_sex'）
    - value: 字典项列表
- **方法**:
  - `setDict(type, data)`: 设置字典数据
  - `getDict(type)`: 获取字典数据
  - `clearAll()`: 清空所有字典缓存
- **持久化**: 使用 `persist` 中间件，存储键为 'dict-storage'
- **使用场景**: 缓存系统字典数据，在需要显示下拉选项、标签等场景使用

### 4. **avatarStore.ts** - 数字人任务数据管理
- **功能**: 缓存数字人相关的任务数据，用于任务恢复和状态保持
- **状态**:
  - `taskCache`: 任务数据缓存（Record<string, AvatarTaskData>）
    - key: 任务 ID 或类型标识（如 'marketing', 'talking_photo'）
    - value: 任务数据（包含 avatarId、voiceId、backgroundId、script 等）
- **方法**:
  - `setTaskData(id, data)`: 设置任务数据
  - `getTaskData(id)`: 获取任务数据
  - `removeTaskData(id)`: 移除任务数据
  - `clearAll()`: 清空所有任务数据
- **持久化**: 使用 `persist` 中间件，存储键为 'avatar-store-storage'
- **使用场景**: 数字人视频生成、照片说话等功能中保存任务参数，支持页面刷新后恢复

### 5. **videoGenerationStore.ts** - 视频生成数据管理
- **功能**: 缓存视频生成相关的数据（如图生视频、风格迁移等）
- **状态**:
  - `transferData`: 生成数据缓存（Record<string, GenerationData>）
    - key: 任务 ID
    - value: 生成数据（包含 images、sourcePrompt、timestamp、source 等）
- **方法**:
  - `setData(id, data)`: 设置生成数据
  - `getData(id)`: 获取生成数据
  - `removeData(id)`: 移除生成数据
- **持久化**: 使用 `persist` 中间件，存储键为 'video-generation-storage'
- **使用场景**: 图生视频、风格迁移等功能中保存生成任务的源数据

### 6. **productVideoStore.ts** - 产品视频任务管理
- **功能**: 缓存产品视频（AI混剪视频）相关的任务数据
- **状态**:
  - `taskCache`: 任务数据缓存（Record<string, ProductVideoData>）
    - key: 任务 ID
    - value: 任务数据（包含 productId、templateId、script、images、videos 等）
- **方法**:
  - `setTaskData(id, data)`: 设置任务数据
  - `getTaskData(id)`: 获取任务数据
  - `removeTaskData(id)`: 移除任务数据
  - `clearAll()`: 清空所有任务数据
- **持久化**: 使用 `persist` 中间件，存储键为 'product-video-store-storage'
- **使用场景**: AI混剪视频功能中保存任务参数，支持任务恢复

### 7. **tenantStore.ts** - 租户信息管理
- **功能**: 管理当前租户（企业/组织）信息
- **状态**:
  - `tenantInfo`: 租户信息（TenantInfo | null）
    - `tenantId`: 租户ID
    - `tenantName`: 租户名称
    - `logo`: 租户Logo
- **方法**:
  - `setTenantInfo(info)`: 设置租户信息
  - `clearTenantInfo()`: 清空租户信息
- **持久化**: 使用 `persist` 中间件，存储键为 'tenant-storage'
- **使用场景**: 多租户系统中管理当前租户信息，用于显示租户相关的UI和功能

## 使用规范

### 基本使用方式
```typescript
import { useAuthStore } from '@/stores/authStore';

function MyComponent() {
  const { user, isAuthenticated, login } = useAuthStore();
  
  // 使用状态
  if (isAuthenticated) {
    return <div>欢迎, {user?.nickName}</div>;
  }
  
  // 调用方法
  const handleLogin = async () => {
    await login({ username: 'user', password: 'pass' });
  };
}
```

### 持久化 Store
使用 `persist` 中间件的 Store 会自动将数据保存到 localStorage，页面刷新后数据不会丢失：
- `authStore`: token 和 userInfo
- `dictStore`: 字典缓存
- `avatarStore`: 数字人任务数据
- `videoGenerationStore`: 视频生成数据
- `productVideoStore`: 产品视频任务数据
- `tenantStore`: 租户信息

### 非持久化 Store
以下 Store 仅保存在内存中，页面刷新后数据会丢失：
- `cacheStore`: 组件缓存列表（通常不需要持久化）

## 注意事项

1. **状态更新**: Zustand 的状态更新是同步的，但异步操作（如 API 调用）需要在方法内部处理
2. **类型安全**: 所有 Store 都使用 TypeScript 定义，提供完整的类型提示
3. **性能优化**: Store 使用选择器（selector）可以避免不必要的重渲染
4. **持久化限制**: localStorage 有大小限制（通常 5-10MB），注意不要存储过大的数据
5. **数据清理**: 登出时应该清理相关的 Store 数据，避免数据泄露

## 添加新 Store

1. 在 `stores/` 目录下创建新的 Store 文件
2. 使用 `create` 创建 Store，定义状态和方法
3. 如需持久化，使用 `persist` 中间件
4. 导出 Store Hook（如 `useXxxStore`）
5. 在组件中导入并使用

## 更新日期

最后更新：2025-01-XX

